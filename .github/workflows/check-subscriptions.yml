
name: Check Subscription Expirations

on:
  schedule:
    - cron: '0 21 * * 4'  # Runs every Thursday at 9 PM UTC
    - cron: '0 9 * * 5'   # Runs every Friday at 9 AM UTC
  workflow_dispatch:      # Allows manual triggering from the GitHub UI

jobs:
  check-subscriptions:
    runs-on: ubuntu-latest
    
    steps:
      - name: Create script directory
        run: mkdir -p scripts
      
      - name: Create subscription checker script
        run: |
          cat > scripts/check-subscriptions.js << 'EOL'
          const admin = require('firebase-admin');
          const { google } = require('googleapis');
          const fetch = require('node-fetch');

          // Initialize Firebase Admin SDK
          const serviceAccount = JSON.parse(process.env.FIREBASE_SERVICE_ACCOUNT);
          admin.initializeApp({
            credential: admin.credential.cert(serviceAccount)
          });

          const db = admin.firestore();
          const projectId = 'nour-elfalam'; // Your Firebase project ID

          // Function to get OAuth 2.0 access token for FCM v1
          async function getAccessTokenAsync(key) {
            const jwtClient = new google.auth.JWT(
              key.client_email,
              null,
              key.private_key,
              ['https://www.googleapis.com/auth/firebase.messaging']
            );
            return new Promise((resolve, reject) => {
              jwtClient.authorize((err, tokens) => {
                if (err) return reject(err);
                resolve(tokens.access_token);
              });
            });
          }

          async function checkSubscriptions() {
            try {
              console.log('Starting to check user subscriptions...');
              
              const currentDate = new Date();
              console.log(`Current date: ${currentDate.toISOString()}`);
              
              // Query users with type "member"
              const usersSnapshot = await db.collection('users')
                .where('type', '==', 'member')
                .get();
                
              console.log(`Found ${usersSnapshot.size} members to check`);
              
              // Group users by expiration status
              const aboutToExpireUsers = [];
              const expiringInHoursUsers = [];
              const expiredUsers = [];
              
              // Process each user
              for (const userDoc of usersSnapshot.docs) {
                const userData = userDoc.data();
                
                // Skip users without expiration date or FCM token
                if (!userData.expirationDate || !userData.fcmToken) {
                  console.log(`User ${userDoc.id} missing expiration date or FCM token, skipping`);
                  continue;
                }
                
                // Calculate days remaining
                const expirationDate = new Date(userData.expirationDate.seconds * 1000);
                let daysRemaining = (expirationDate.getTime() - currentDate.getTime()) / (1000 * 60 * 60 * 24);
                
                console.log(`User ${userDoc.id}: ${daysRemaining.toFixed(1)} days remaining`);
                
                // Check if subscription is about to expire or has expired
                if (daysRemaining < 6) {
                  if (daysRemaining > 1) {
                    // More than 1 day but less than 6 days remaining
                    aboutToExpireUsers.push({
                      subId: userData.subId,
                      fcmToken: userData.fcmToken,
                      daysRemaining: Math.round(daysRemaining)
                    });
                  } else if (daysRemaining > 0.02083) { // About 30 minutes in days
                    // Less than 1 day but still active
                    const hoursRemaining = Math.round(daysRemaining * 24);
                    const minutesRemaining = Math.round((daysRemaining * 24 * 60) % 60);
                    expiringInHoursUsers.push({
                      subId: userData.subId,
                      fcmToken: userData.fcmToken,
                      hoursRemaining,
                      minutesRemaining
                    });
                  } else {
                    // Already expired
                    expiredUsers.push({
                      subId: userData.subId,
                      fcmToken: userData.fcmToken,
                      daysExpired: Math.round(Math.abs(daysRemaining))
                    });
                  }
                }
              }
              
              // Send notifications to each group
              await sendNotifications(aboutToExpireUsers, expiringInHoursUsers, expiredUsers);
              
              console.log('Finished checking subscriptions');
            } catch (error) {
              console.error('Error checking subscriptions:', error);
              process.exit(1);
            }
          }

          async function sendNotifications(aboutToExpireUsers, expiringInHoursUsers, expiredUsers) {
            try {
              // Send notifications to users with days remaining
              if (aboutToExpireUsers.length > 0) {
                for (const user of aboutToExpireUsers) {
                  const message = `Votre abonnement bientôt expire dans ${user.daysRemaining} jour${user.daysRemaining !== 1 ? 's' : ''}.`;
                  await sendNotification(user.fcmToken, 'Rappel d\'abonnement', message);
                }
              }
              
              // Send notifications to users with hours remaining
              if (expiringInHoursUsers.length > 0) {
                for (const user of expiringInHoursUsers) {
                  const message = `Votre abonnement expire dans ${user.hoursRemaining} heure${user.hoursRemaining !== 1 ? 's' : ''} et ${user.minutesRemaining} minute${user.minutesRemaining !== 1 ? 's' : ''}.`;
                  await sendNotification(user.fcmToken, 'Rappel d\'abonnement', message);
                }
              }
              
              // Send notifications to users with expired subscriptions
              if (expiredUsers.length > 0) {
                for (const user of expiredUsers) {
                  const message = `Votre abonnement a expiré il y a ${user.daysExpired} jour${user.daysExpired !== 1 ? 's' : ''}. Veuillez renouveler pour continuer.`;
                  await sendNotification(user.fcmToken, 'Abonnement expiré', message);
                }
              }
              
              console.log(`Sent notifications to ${aboutToExpireUsers.length + expiringInHoursUsers.length + expiredUsers.length} users`);
            } catch (error) {
              console.error('Error sending notifications:', error);
              throw error;
            }
          }

          async function sendNotification(fcmToken, title, message) {
            try {
              console.log(`Sending FCM v1 notification to token: ${fcmToken} - "${title}" - "${message}"`);
              
              // Get OAuth 2.0 access token
              const firebaseAccessToken = await getAccessTokenAsync(serviceAccount);

              // FCM v1 payload
              const messageBody = {
                message: {
                  token: fcmToken,
                  notification: {
                    title: title,
                    body: message,
                  },
                  data: {
                    channelId: 'default', // Matches the channel set in expo-notifications
                    notificationType: 'subscription',
                  },
                  android: {
                    priority: 'high',
                    notification: {
                      channelId: 'default',
                      sound: 'default',
                      image: 'https://images.unsplash.com/photo-1558002038-1055907df827?w=800&auto=format&fit=crop',
                    },
                  },
                },
              };

              // Send notification via FCM v1 API
              const response = await fetch(
                `https://fcm.googleapis.com/v1/projects/${projectId}/messages:send`,
                {
                  method: 'POST',
                  headers: {
                    Authorization: `Bearer ${firebaseAccessToken}`,
                    Accept: 'application/json',
                    'Accept-encoding': 'gzip, deflate',
                    'Content-Type': 'application/json',
                  },
                  body: JSON.stringify(messageBody),
                }
              );

              const responseData = await response.json();
              if (!response.ok) {
                throw new Error(`FCM v1 API error: ${JSON.stringify(responseData)}`);
              }
              
              console.log(`Notification sent successfully to ${fcmToken}:`, responseData);
              return responseData;
            } catch (error) {
              console.error(`Failed to send notification to ${fcmToken}:`, error);
              throw error;
            }
          }

          // Execute the main function
          checkSubscriptions()
            .then(() => {
              console.log('Process completed successfully');
              process.exit(0);
            })
            .catch((error) => {
              console.error('Process failed:', error);
              process.exit(1);
            });
          EOL
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          
      - name: Install dependencies
        run: |
          npm install firebase-admin googleapis node-fetch
          
      - name: Check subscriptions and send notifications
        env:
          FIREBASE_SERVICE_ACCOUNT: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
        run: node scripts/check-subscriptions.js

