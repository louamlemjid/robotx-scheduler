name: Send Group Notifications to Native Notify

on:
  schedule:
    - cron: '*/5 * * * *'  # Runs every 5 minutes
  workflow_dispatch:  # Allows manual triggering from the GitHub UI

jobs:
  send-notification:
    runs-on: ubuntu-latest
    
    steps:
      - name: Create script directory
        run: mkdir -p scripts
      
      - name: Create notification script
        run: |
          cat > scripts/send-notification.js << 'EOL'
          async function sendGroupNotification() {
            try {
              console.log('Sending group notification to Native Notify...');
              
              // Parse the subscriber IDs from environment variable
              const subscriberIds = process.env.SUBSCRIBER_IDS.split(',').map(id => id.trim());
              
              const response = await fetch('https://app.nativenotify.com/api/indie/group/notification', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                  subIDs: subscriberIds,
                  appId: parseInt(process.env.NATIVE_NOTIFY_APP_ID),
                  appToken: process.env.NATIVE_NOTIFY_APP_TOKEN,
                  title: process.env.NOTIFICATION_TITLE || 'Notification',
                  message: process.env.NOTIFICATION_MESSAGE || 'You have a new notification',
                  pushData: {
                    notificationType: 'event',
                  },
                }),
              });
              
              
              console.log('Notification sent successfully:',response.status);
            } catch (error) {
              console.error('Error sending notification:', error);
            }
          }

          // Execute the function
          sendGroupNotification()
            .then(() => {
              console.log('Process completed successfully');
              process.exit(0);
            })
            .catch((error) => {
              console.error('Process failed:', error);
              process.exit(1);
            });
          EOL
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          
      - name: Process and send notification
        env:
          NATIVE_NOTIFY_APP_ID: ${{ secrets.NATIVE_NOTIFY_APP_ID }}
          NATIVE_NOTIFY_APP_TOKEN: ${{ secrets.NATIVE_NOTIFY_APP_TOKEN }}
          SUBSCRIBER_IDS: ${{ secrets.SUBSCRIBER_IDS }}
          NOTIFICATION_TITLE: ${{ secrets.NOTIFICATION_TITLE || 'test7' }}
          NOTIFICATION_MESSAGE: ${{ secrets.NOTIFICATION_MESSAGE || 'yo' }}
        run: node scripts/send-notification.js
